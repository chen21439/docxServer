<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Viewer with Text Selection</title>
  <!-- PDF.js CSS for text layer -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #111827;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    #controls {
      flex-shrink: 0;
      z-index: 10;
      background: #0f172a;
      border-bottom: 1px solid #1f2937;
      padding: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #controls input {
      padding: 8px;
      border: 1px solid #374151;
      border-radius: 3px;
      background: #1f2937;
      color: #e5e7eb;
      width: 400px;
    }
    #controls button {
      padding: 8px 16px;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 3px;
      cursor: pointer;
    }
    #controls button:hover {
      background: #111827;
    }
    #page-info {
      margin-left: auto;
      font-size: 14px;
      color: #9ca3af;
    }
    #pdf-container {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 16px;
    }
    #right-panel {
      width: 400px;
      background: #0f172a;
      border-left: 1px solid #1f2937;
      overflow-y: auto;
      flex-shrink: 0;
    }
    #right-panel h3 {
      margin: 0;
      padding: 15px;
      background: #1e293b;
      border-bottom: 1px solid #1f2937;
      font-size: 16px;
      color: #fbbf24;
    }
    #selection-info {
      padding: 15px;
      font-size: 13px;
      line-height: 1.6;
    }
    #selection-info pre {
      background: #1e293b;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      margin: 10px 0;
    }
    .info-section {
      margin-bottom: 20px;
    }
    .info-label {
      color: #9ca3af;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .info-value {
      color: #e5e7eb;
      word-break: break-all;
    }
    .quad-item {
      background: #1e293b;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
    }
    .no-selection {
      color: #6b7280;
      font-style: italic;
      text-align: center;
      padding: 40px 20px;
    }
    .page-wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .page-number {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: #9ca3af;
      font-weight: bold;
    }
    .page-container {
      position: relative;
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }
    canvas.pdf-canvas {
      display: block;
      background: white;
    }
    /* PDF.js text layer styles */
    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      opacity: 0.2;
      line-height: 1.0;
    }
    .textLayer > span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
    }
    .textLayer ::selection {
      background: blue;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="text" id="pdf-url" value="/pdf/file/1978018096320905217.pdf" placeholder="输入 PDF URL" />
    <button id="load-pdf">加载 PDF</button>
    <button id="prev-page">上一页</button>
    <button id="next-page">下一页</button>
    <button id="zoom-out">缩小</button>
    <span id="zoom-info">100%</span>
    <button id="zoom-in">放大</button>
    <span id="page-info">准备加载...</span>
  </div>

  <div id="main-content">
    <div id="pdf-container"></div>
    <div id="right-panel">
      <h3>选中文本信息</h3>
      <div id="selection-info">
        <div class="no-selection">请在PDF中选择文本</div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>
  <script>
    // PDF.js worker configuration
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const pdfUrlInput = document.getElementById('pdf-url');
    const loadButton = document.getElementById('load-pdf');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomInfo = document.getElementById('zoom-info');
    const pdfContainer = document.getElementById('pdf-container');
    const pageInfo = document.getElementById('page-info');

    let pdfDoc = null;
    let scale = 1.5;
    const pages = [];
    let currentPage = 5; // 默认第5页

    // 渲染单个页面
    async function renderPage(page, pageNumber) {
      const viewport = page.getViewport({ scale });

      // 页面包装器
      const pageWrapper = document.createElement('div');
      pageWrapper.className = 'page-wrapper';
      pageWrapper.id = 'page-' + pageNumber;

      // 页码标签
      const pageLabel = document.createElement('div');
      pageLabel.className = 'page-number';
      pageLabel.textContent = 'Page ' + pageNumber;

      // 页面容器
      const pageContainer = document.createElement('div');
      pageContainer.className = 'page-container';
      pageContainer.style.width = viewport.width + 'px';
      pageContainer.style.height = viewport.height + 'px';
      pageContainer.dataset.pageNumber = pageNumber;

      // 创建画布
      const canvas = document.createElement('canvas');
      canvas.className = 'pdf-canvas';
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');

      // 创建文本层
      const textLayerDiv = document.createElement('div');
      textLayerDiv.className = 'textLayer';
      textLayerDiv.style.width = viewport.width + 'px';
      textLayerDiv.style.height = viewport.height + 'px';

      pageContainer.appendChild(canvas);
      pageContainer.appendChild(textLayerDiv);
      pageWrapper.appendChild(pageLabel);
      pageWrapper.appendChild(pageContainer);
      pdfContainer.appendChild(pageWrapper);

      // 渲染 PDF 页面到画布
      await page.render({ canvasContext: ctx, viewport }).promise;

      // 使用 PDF.js 官方的 TextLayerBuilder 渲染文本层
      const textContent = await page.getTextContent();

      // 使用 PDF.js 的 renderTextLayer API
      pdfjsLib.renderTextLayer({
        textContentSource: textContent,
        container: textLayerDiv,
        viewport: viewport,
        textDivs: []
      });

      pages.push({ page, viewport, div: pageContainer, canvas, ctx, textLayerDiv });
    }

    // 渲染单页
    async function renderSinglePage(pageNum) {
      if (!pdfDoc) return;
      if (pageNum < 1 || pageNum > pdfDoc.numPages) return;

      pdfContainer.innerHTML = '';
      pages.length = 0;

      const page = await pdfDoc.getPage(pageNum);
      await renderPage(page, pageNum);

      currentPage = pageNum;
      zoomInfo.textContent = Math.round(scale * 100) + '%';
      pageInfo.textContent = `第 ${pageNum} 页 / 共 ${pdfDoc.numPages} 页`;

      // 清空右侧面板
      updateSelectionPanel(null);
    }

    // 加载 PDF
    async function loadPDF(url) {
      try {
        pageInfo.textContent = '正在加载 PDF...';
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;

        // 加载默认页（第5页）
        await renderSinglePage(currentPage);
      } catch (error) {
        pageInfo.textContent = '加载失败: ' + error.message;
        console.error('Error loading PDF:', error);
      }
    }

    // 重新渲染（缩放后）
    async function rerenderAtScale() {
      if (!pdfDoc) return;
      await renderSinglePage(currentPage);
    }

    // 事件监听
    loadButton.addEventListener('click', function() {
      const url = pdfUrlInput.value.trim();
      if (url) {
        loadPDF(url);
      } else {
        alert('请输入 PDF URL');
      }
    });

    pdfUrlInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadButton.click();
      }
    });

    // 上一页
    prevPageBtn.addEventListener('click', async () => {
      if (!pdfDoc) return;
      if (currentPage > 1) {
        await renderSinglePage(currentPage - 1);
      }
    });

    // 下一页
    nextPageBtn.addEventListener('click', async () => {
      if (!pdfDoc) return;
      if (currentPage < pdfDoc.numPages) {
        await renderSinglePage(currentPage + 1);
      }
    });

    zoomInBtn.addEventListener('click', async () => {
      if (!pdfDoc) return;
      scale = Math.min(4, scale + 0.25);
      await rerenderAtScale();
    });

    zoomOutBtn.addEventListener('click', async () => {
      if (!pdfDoc) return;
      scale = Math.max(0.5, scale - 0.25);
      await rerenderAtScale();
    });

    // 自动加载默认 PDF
    window.addEventListener('load', function() {
      const defaultUrl = pdfUrlInput.value;
      if (defaultUrl) {
        loadPDF(defaultUrl);
      }
    });

    // 从选区提取 QuadPoints 信息
    function selectionToPayload(pdf, pages) {
      const sel = window.getSelection();
      if (!sel || sel.isCollapsed) return null;

      const groupByPage = new Map();

      for (let i = 0; i < sel.rangeCount; i++) {
        const range = sel.getRangeAt(i);
        for (const r of Array.from(range.getClientRects())) {
          const el = document.elementFromPoint(r.left + 1, r.top + 1);
          const pageDiv = el?.closest?.(".page-container");
          if (!pageDiv) continue;

          const pageNumber = Number(pageDiv.dataset.pageNumber);
          // 在单页模式下，pages 数组只有一个元素
          const pageData = pages[0];
          if (!pageData) continue;

          const { viewport } = pageData;
          const pageBox = pageDiv.getBoundingClientRect();

          // 视口像素 → PDF 坐标（QuadPoints: 上左、上右、下左、下右）
          const tl = viewport.convertToPdfPoint(r.left - pageBox.left,  r.top    - pageBox.top);
          const tr = viewport.convertToPdfPoint(r.right - pageBox.left, r.top    - pageBox.top);
          const bl = viewport.convertToPdfPoint(r.left - pageBox.left,  r.bottom - pageBox.top);
          const br = viewport.convertToPdfPoint(r.right - pageBox.left, r.bottom - pageBox.top);

          const pageArr = groupByPage.get(pageNumber) || [];
          // QuadPoints 格式: [ulx, uly, urx, ury, llx, lly, lrx, lry]
          pageArr.push([tl[0], tl[1], tr[0], tr[1], bl[0], bl[1], br[0], br[1]]);
          groupByPage.set(pageNumber, pageArr);
        }
      }

      const selections = Array.from(groupByPage.entries()).map(([page, quads]) => ({
        page,
        quads
      }));

      return {
        doc: { fingerprint: pdf.fingerprint, unit: "pt" },
        selections,
        text: sel.toString()
      };
    }

    // 更新右侧面板显示
    function updateSelectionPanel(payload) {
      const panel = document.getElementById('selection-info');

      if (!payload) {
        panel.innerHTML = '<div class="no-selection">请在PDF中选择文本</div>';
        return;
      }

      let html = '';

      // 显示选中文本
      html += '<div class="info-section">';
      html += '<div class="info-label">选中文本：</div>';
      html += `<div class="info-value">${payload.text || '(无)'}</div>`;
      html += '</div>';

      // 显示文档指纹
      html += '<div class="info-section">';
      html += '<div class="info-label">文档指纹：</div>';
      html += `<div class="info-value">${payload.doc.fingerprint}</div>`;
      html += '</div>';

      // 显示坐标单位
      html += '<div class="info-section">';
      html += '<div class="info-label">坐标单位：</div>';
      html += `<div class="info-value">${payload.doc.unit}</div>`;
      html += '</div>';

      // 显示每页的 QuadPoints
      html += '<div class="info-section">';
      html += '<div class="info-label">QuadPoints（PDF 坐标）：</div>';
      payload.selections.forEach(sel => {
        html += `<div style="margin-top:10px;"><strong>第 ${sel.page} 页：</strong></div>`;
        sel.quads.forEach((quad, idx) => {
          html += `<div class="quad-item">`;
          html += `Quad ${idx + 1}:<br>`;
          html += `UL: (${quad[0].toFixed(2)}, ${quad[1].toFixed(2)})<br>`;
          html += `UR: (${quad[2].toFixed(2)}, ${quad[3].toFixed(2)})<br>`;
          html += `LL: (${quad[4].toFixed(2)}, ${quad[5].toFixed(2)})<br>`;
          html += `LR: (${quad[6].toFixed(2)}, ${quad[7].toFixed(2)})`;
          html += `</div>`;
        });
      });
      html += '</div>';

      // 显示完整 JSON
      html += '<div class="info-section">';
      html += '<div class="info-label">完整 JSON：</div>';
      html += `<pre>${JSON.stringify(payload, null, 2)}</pre>`;
      html += '</div>';

      panel.innerHTML = html;
    }

    // 监听选择变化
    document.addEventListener('selectionchange', function() {
      if (!pdfDoc || pages.length === 0) return;

      const payload = selectionToPayload(pdfDoc, pages);
      updateSelectionPanel(payload);
    });

    // 暴露到全局，便于调试
    window.__pdfViewer = { pages, pdfDoc, selectionToPayload };
  </script>
</body>
</html>
